/**
 * フォントメトリクスデータ。
 * OSS のメトリクス互換フォントから scripts/extract-font-metrics.ts で抽出。
 *
 * - Carlito (SIL OFL) → Calibri 互換
 * - Liberation Sans (SIL OFL) → Arial / Helvetica 互換
 * - Liberation Serif (SIL OFL) → Times New Roman 互換
 * - Noto Sans JP (SIL OFL) → 日本語フォント全般
 */

export interface FontMetrics {
  unitsPerEm: number;
  ascender: number;
  descender: number;
  widths: Readonly<Record<string, number>>;
  defaultWidth: number;
  cjkWidth: number;
}

// prettier-ignore
const metricsData: Record<string, FontMetrics> = {
  Carlito: {
    unitsPerEm: 2048,
    ascender: 1950,
    descender: -550,
    defaultWidth: 991,
    cjkWidth: 2048,
    widths: {
      " ": 463, "!": 667, "\"": 821, "#": 1020, "$": 1038, "%": 1464, "&": 1397, "'": 452,
      "(": 621, ")": 621, "*": 1020, "+": 1020, ",": 511, "-": 627, ".": 517, "/": 791,
      "0": 1038, "1": 1038, "2": 1038, "3": 1038, "4": 1038, "5": 1038, "6": 1038, "7": 1038,
      "8": 1038, "9": 1038, ":": 548, ";": 548, "<": 1020, "=": 1020, ">": 1020, "?": 949,
      "@": 1831, "A": 1185, "B": 1114, "C": 1092, "D": 1260, "E": 1000, "F": 941, "G": 1292,
      "H": 1276, "I": 516, "J": 653, "K": 1064, "L": 861, "M": 1751, "N": 1322, "O": 1356,
      "P": 1058, "Q": 1378, "R": 1112, "S": 941, "T": 998, "U": 1314, "V": 1162, "W": 1822,
      "X": 1063, "Y": 998, "Z": 959, "[": 628, "\\": 791, "]": 628, "^": 1020, "_": 1020,
      "`": 596, "a": 981, "b": 1076, "c": 866, "d": 1076, "e": 1019, "f": 625, "g": 964,
      "h": 1076, "i": 470, "j": 490, "k": 931, "l": 470, "m": 1636, "n": 1076, "o": 1080,
      "p": 1076, "q": 1076, "r": 714, "s": 801, "t": 686, "u": 1076, "v": 925, "w": 1464,
      "x": 887, "y": 927, "z": 809, "{": 644, "|": 943, "}": 644, "~": 1020,
      "\u00a0": 463, "\u00a1": 667, "\u00a2": 1020, "\u00a3": 1038, "\u00a4": 1020,
      "\u00a5": 1038, "\u00a6": 1020, "\u00a7": 1020, "\u00a8": 804, "\u00a9": 1709,
      "\u00aa": 824, "\u00ab": 1049, "\u00ac": 1020, "\u00ae": 1038, "\u00af": 807,
      "\u00b0": 694, "\u00b1": 1020, "\u00b2": 688, "\u00b3": 685, "\u00b4": 598,
      "\u00b5": 1126, "\u00b6": 1200, "\u00b7": 517, "\u00b8": 629, "\u00b9": 504,
      "\u00ba": 865, "\u00bb": 1049, "\u00bc": 1303, "\u00bd": 1375, "\u00be": 1383,
      "\u00bf": 949, "\u00c0": 1185, "\u00c1": 1185, "\u00c2": 1185, "\u00c3": 1185,
      "\u00c4": 1185, "\u00c5": 1185, "\u00c6": 1563, "\u00c7": 1092, "\u00c8": 1000,
      "\u00c9": 1000, "\u00ca": 1000, "\u00cb": 1000, "\u00cc": 516, "\u00cd": 516,
      "\u00ce": 516, "\u00cf": 516, "\u00d0": 1279, "\u00d1": 1322, "\u00d2": 1356,
      "\u00d3": 1356, "\u00d4": 1356, "\u00d5": 1356, "\u00d6": 1356, "\u00d7": 1020,
      "\u00d8": 1359, "\u00d9": 1314, "\u00da": 1314, "\u00db": 1314, "\u00dc": 1314,
      "\u00dd": 998, "\u00de": 1058, "\u00df": 1080, "\u00e0": 981, "\u00e1": 981,
      "\u00e2": 981, "\u00e3": 981, "\u00e4": 981, "\u00e5": 981, "\u00e6": 1583,
      "\u00e7": 866, "\u00e8": 1019, "\u00e9": 1019, "\u00ea": 1019, "\u00eb": 1019,
      "\u00ec": 470, "\u00ed": 470, "\u00ee": 470, "\u00ef": 470, "\u00f0": 1076,
      "\u00f1": 1076, "\u00f2": 1080, "\u00f3": 1080, "\u00f4": 1080, "\u00f5": 1080,
      "\u00f6": 1080, "\u00f7": 1020, "\u00f8": 1084, "\u00f9": 1076, "\u00fa": 1076,
      "\u00fb": 1076, "\u00fc": 1076, "\u00fd": 927, "\u00fe": 1076, "\u00ff": 927,
    },
  },
  LiberationSans: {
    unitsPerEm: 2048,
    ascender: 1854,
    descender: -434,
    defaultWidth: 1114,
    cjkWidth: 2048,
    widths: {
      " ": 569, "!": 569, "\"": 727, "#": 1139, "$": 1139, "%": 1821, "&": 1366, "'": 391,
      "(": 682, ")": 682, "*": 797, "+": 1196, ",": 569, "-": 682, ".": 569, "/": 569,
      "0": 1139, "1": 1139, "2": 1139, "3": 1139, "4": 1139, "5": 1139, "6": 1139, "7": 1139,
      "8": 1139, "9": 1139, ":": 569, ";": 569, "<": 1196, "=": 1196, ">": 1196, "?": 1139,
      "@": 2079, "A": 1366, "B": 1366, "C": 1479, "D": 1479, "E": 1366, "F": 1251, "G": 1593,
      "H": 1479, "I": 569, "J": 1024, "K": 1366, "L": 1139, "M": 1706, "N": 1479, "O": 1593,
      "P": 1366, "Q": 1593, "R": 1479, "S": 1366, "T": 1251, "U": 1479, "V": 1366, "W": 1933,
      "X": 1366, "Y": 1366, "Z": 1251, "[": 569, "\\": 569, "]": 569, "^": 961, "_": 1139,
      "`": 682, "a": 1139, "b": 1139, "c": 1024, "d": 1139, "e": 1139, "f": 569, "g": 1139,
      "h": 1139, "i": 455, "j": 455, "k": 1024, "l": 455, "m": 1706, "n": 1139, "o": 1139,
      "p": 1139, "q": 1139, "r": 682, "s": 1024, "t": 569, "u": 1139, "v": 1024, "w": 1479,
      "x": 1024, "y": 1024, "z": 1024, "{": 684, "|": 532, "}": 684, "~": 1196,
      "\u00a0": 569, "\u00a1": 682, "\u00a2": 1139, "\u00a3": 1139, "\u00a4": 1139,
      "\u00a5": 1139, "\u00a6": 532, "\u00a7": 1139, "\u00a8": 682, "\u00a9": 1509,
      "\u00aa": 758, "\u00ab": 1139, "\u00ac": 1196, "\u00ad": 682, "\u00ae": 1509,
      "\u00af": 1131, "\u00b0": 819, "\u00b1": 1124, "\u00b2": 682, "\u00b3": 682,
      "\u00b4": 682, "\u00b5": 1180, "\u00b6": 1100, "\u00b7": 682, "\u00b8": 682,
      "\u00b9": 682, "\u00ba": 748, "\u00bb": 1139, "\u00bc": 1708, "\u00bd": 1708,
      "\u00be": 1708, "\u00bf": 1251, "\u00c0": 1366, "\u00c1": 1366, "\u00c2": 1366,
      "\u00c3": 1366, "\u00c4": 1366, "\u00c5": 1366, "\u00c6": 2048, "\u00c7": 1479,
      "\u00c8": 1366, "\u00c9": 1366, "\u00ca": 1366, "\u00cb": 1366, "\u00cc": 569,
      "\u00cd": 569, "\u00ce": 569, "\u00cf": 569, "\u00d0": 1479, "\u00d1": 1479,
      "\u00d2": 1593, "\u00d3": 1593, "\u00d4": 1593, "\u00d5": 1593, "\u00d6": 1593,
      "\u00d7": 1196, "\u00d8": 1593, "\u00d9": 1479, "\u00da": 1479, "\u00db": 1479,
      "\u00dc": 1479, "\u00dd": 1366, "\u00de": 1366, "\u00df": 1251, "\u00e0": 1139,
      "\u00e1": 1139, "\u00e2": 1139, "\u00e3": 1139, "\u00e4": 1139, "\u00e5": 1139,
      "\u00e6": 1821, "\u00e7": 1024, "\u00e8": 1139, "\u00e9": 1139, "\u00ea": 1139,
      "\u00eb": 1139, "\u00ec": 569, "\u00ed": 569, "\u00ee": 569, "\u00ef": 569,
      "\u00f0": 1139, "\u00f1": 1139, "\u00f2": 1139, "\u00f3": 1139, "\u00f4": 1139,
      "\u00f5": 1139, "\u00f6": 1139, "\u00f7": 1124, "\u00f8": 1251, "\u00f9": 1139,
      "\u00fa": 1139, "\u00fb": 1139, "\u00fc": 1139, "\u00fd": 1024, "\u00fe": 1139,
      "\u00ff": 1024,
    },
  },
  LiberationSerif: {
    unitsPerEm: 2048,
    ascender: 1825,
    descender: -443,
    defaultWidth: 1056,
    cjkWidth: 2048,
    widths: {
      " ": 512, "!": 682, "\"": 836, "#": 1024, "$": 1024, "%": 1706, "&": 1593, "'": 369,
      "(": 682, ")": 682, "*": 1024, "+": 1155, ",": 512, "-": 682, ".": 512, "/": 569,
      "0": 1024, "1": 1024, "2": 1024, "3": 1024, "4": 1024, "5": 1024, "6": 1024, "7": 1024,
      "8": 1024, "9": 1024, ":": 569, ";": 569, "<": 1155, "=": 1155, ">": 1155, "?": 909,
      "@": 1886, "A": 1479, "B": 1366, "C": 1366, "D": 1479, "E": 1251, "F": 1139, "G": 1479,
      "H": 1479, "I": 682, "J": 797, "K": 1479, "L": 1251, "M": 1821, "N": 1479, "O": 1479,
      "P": 1139, "Q": 1479, "R": 1366, "S": 1139, "T": 1251, "U": 1479, "V": 1479, "W": 1933,
      "X": 1479, "Y": 1479, "Z": 1251, "[": 682, "\\": 569, "]": 682, "^": 961, "_": 1024,
      "`": 682, "a": 909, "b": 1024, "c": 909, "d": 1024, "e": 909, "f": 682, "g": 1024,
      "h": 1024, "i": 569, "j": 569, "k": 1024, "l": 569, "m": 1593, "n": 1024, "o": 1024,
      "p": 1024, "q": 1024, "r": 682, "s": 797, "t": 569, "u": 1024, "v": 1024, "w": 1479,
      "x": 1024, "y": 1024, "z": 909, "{": 983, "|": 410, "}": 983, "~": 1108,
      "\u00a0": 512, "\u00a1": 682, "\u00a2": 1024, "\u00a3": 1024, "\u00a4": 1024,
      "\u00a5": 1024, "\u00a6": 410, "\u00a7": 1024, "\u00a8": 682, "\u00a9": 1556,
      "\u00aa": 565, "\u00ab": 1024, "\u00ac": 1155, "\u00ad": 682, "\u00ae": 1556,
      "\u00af": 1024, "\u00b0": 819, "\u00b1": 1124, "\u00b2": 614, "\u00b3": 614,
      "\u00b4": 682, "\u00b5": 1180, "\u00b6": 928, "\u00b7": 682, "\u00b8": 682,
      "\u00b9": 614, "\u00ba": 635, "\u00bb": 1024, "\u00bc": 1536, "\u00bd": 1536,
      "\u00be": 1536, "\u00bf": 909, "\u00c0": 1479, "\u00c1": 1479, "\u00c2": 1479,
      "\u00c3": 1479, "\u00c4": 1479, "\u00c5": 1479, "\u00c6": 1821, "\u00c7": 1366,
      "\u00c8": 1251, "\u00c9": 1251, "\u00ca": 1251, "\u00cb": 1251, "\u00cc": 682,
      "\u00cd": 682, "\u00ce": 682, "\u00cf": 682, "\u00d0": 1479, "\u00d1": 1479,
      "\u00d2": 1479, "\u00d3": 1479, "\u00d4": 1479, "\u00d5": 1479, "\u00d6": 1479,
      "\u00d7": 1155, "\u00d8": 1479, "\u00d9": 1479, "\u00da": 1479, "\u00db": 1479,
      "\u00dc": 1479, "\u00dd": 1479, "\u00de": 1139, "\u00df": 1024, "\u00e0": 909,
      "\u00e1": 909, "\u00e2": 909, "\u00e3": 909, "\u00e4": 909, "\u00e5": 909,
      "\u00e6": 1366, "\u00e7": 909, "\u00e8": 909, "\u00e9": 909, "\u00ea": 909,
      "\u00eb": 909, "\u00ec": 569, "\u00ed": 569, "\u00ee": 569, "\u00ef": 569,
      "\u00f0": 1024, "\u00f1": 1024, "\u00f2": 1024, "\u00f3": 1024, "\u00f4": 1024,
      "\u00f5": 1024, "\u00f6": 1024, "\u00f7": 1124, "\u00f8": 1024, "\u00f9": 1024,
      "\u00fa": 1024, "\u00fb": 1024, "\u00fc": 1024, "\u00fd": 1024, "\u00fe": 1024,
      "\u00ff": 1024,
    },
  },
  NotoSansJP: {
    unitsPerEm: 1000,
    ascender: 1160,
    descender: -288,
    defaultWidth: 563,
    cjkWidth: 1000,
    widths: {
      " ": 224, "!": 323, "\"": 474, "#": 555, "$": 555, "%": 921, "&": 680, "'": 278,
      "(": 338, ")": 338, "*": 467, "+": 555, ",": 278, "-": 347, ".": 278, "/": 392,
      "0": 555, "1": 555, "2": 555, "3": 555, "4": 555, "5": 555, "6": 555, "7": 555,
      "8": 555, "9": 555, ":": 278, ";": 278, "<": 555, "=": 555, ">": 555, "?": 474,
      "@": 946, "A": 608, "B": 657, "C": 638, "D": 688, "E": 589, "F": 552, "G": 689,
      "H": 728, "I": 293, "J": 535, "K": 646, "L": 543, "M": 812, "N": 723, "O": 742,
      "P": 633, "Q": 742, "R": 635, "S": 596, "T": 599, "U": 721, "V": 575, "W": 878,
      "X": 573, "Y": 531, "Z": 603, "[": 338, "\\": 392, "]": 338, "^": 555, "_": 559,
      "`": 606, "a": 563, "b": 618, "c": 510, "d": 620, "e": 554, "f": 325, "g": 564,
      "h": 607, "i": 275, "j": 275, "k": 552, "l": 284, "m": 926, "n": 610, "o": 606,
      "p": 620, "q": 620, "r": 388, "s": 468, "t": 377, "u": 607, "v": 521, "w": 802,
      "x": 498, "y": 521, "z": 475, "{": 338, "|": 270, "}": 338, "~": 555,
      "\u00a0": 224, "\u00a1": 323, "\u00a2": 555, "\u00a3": 555, "\u00a4": 555,
      "\u00a5": 555, "\u00a6": 270, "\u00a7": 1000, "\u00a8": 606, "\u00a9": 832,
      "\u00aa": 386, "\u00ab": 479, "\u00ac": 555, "\u00ad": 347, "\u00ae": 473,
      "\u00af": 606, "\u00b0": 370, "\u00b1": 1000, "\u00b2": 411, "\u00b3": 411,
      "\u00b4": 606, "\u00b5": 628, "\u00b6": 1000, "\u00b7": 561, "\u00b8": 606,
      "\u00b9": 411, "\u00ba": 407, "\u00bb": 479, "\u00bc": 873, "\u00bd": 903,
      "\u00be": 889, "\u00bf": 474, "\u00c0": 608, "\u00c1": 608, "\u00c2": 608,
      "\u00c3": 608, "\u00c4": 608, "\u00c5": 608, "\u00c6": 918, "\u00c7": 638,
      "\u00c8": 589, "\u00c9": 589, "\u00ca": 589, "\u00cb": 589, "\u00cc": 293,
      "\u00cd": 293, "\u00ce": 293, "\u00cf": 293, "\u00d0": 712, "\u00d1": 723,
      "\u00d2": 742, "\u00d3": 742, "\u00d4": 742, "\u00d5": 742, "\u00d6": 742,
      "\u00d7": 1000, "\u00d8": 742, "\u00d9": 721, "\u00da": 721, "\u00db": 721,
      "\u00dc": 721, "\u00dd": 531, "\u00de": 652, "\u00df": 643, "\u00e0": 563,
      "\u00e1": 563, "\u00e2": 563, "\u00e3": 563, "\u00e4": 563, "\u00e5": 563,
      "\u00e6": 877, "\u00e7": 510, "\u00e8": 554, "\u00e9": 554, "\u00ea": 554,
      "\u00eb": 554, "\u00ec": 275, "\u00ed": 275, "\u00ee": 275, "\u00ef": 275,
      "\u00f0": 608, "\u00f1": 610, "\u00f2": 606, "\u00f3": 606, "\u00f4": 606,
      "\u00f5": 606, "\u00f6": 606, "\u00f7": 1000, "\u00f8": 606, "\u00f9": 607,
      "\u00fa": 607, "\u00fb": 607, "\u00fc": 607, "\u00fd": 521, "\u00fe": 620,
      "\u00ff": 521,
    },
  },
};

/**
 * PPTX フォント名 → メトリクスデータキーのマッピング。
 * 大文字小文字両方を登録して高速ルックアップを可能にする。
 */
const fontNameMap: Record<string, string> = {
  // Calibri → Carlito
  Calibri: "Carlito",
  calibri: "Carlito",
  // Arial / Helvetica → Liberation Sans
  Arial: "LiberationSans",
  arial: "LiberationSans",
  Helvetica: "LiberationSans",
  helvetica: "LiberationSans",
  // Times New Roman → Liberation Serif
  "Times New Roman": "LiberationSerif",
  "times new roman": "LiberationSerif",
  // 日本語フォント → Noto Sans JP
  "MS PGothic": "NotoSansJP",
  "MS Pゴシック": "NotoSansJP",
  "MS Gothic": "NotoSansJP",
  "MS ゴシック": "NotoSansJP",
  Meiryo: "NotoSansJP",
  メイリオ: "NotoSansJP",
  "Yu Gothic": "NotoSansJP",
  游ゴシック: "NotoSansJP",
  "Yu Mincho": "NotoSansJP",
  游明朝: "NotoSansJP",
  "Hiragino Sans": "NotoSansJP",
  "Hiragino Kaku Gothic ProN": "NotoSansJP",
  "Noto Sans JP": "NotoSansJP",
  "Noto Sans CJK JP": "NotoSansJP",
};

/**
 * メトリクスキー → 実際の OSS フォント名。
 * SVG の font-family フォールバックに使用する。
 */
const metricsKeyToFontName: Record<string, string> = {
  Carlito: "Carlito",
  LiberationSans: "Liberation Sans",
  LiberationSerif: "Liberation Serif",
  NotoSansJP: "Noto Sans JP",
};

/**
 * フォント名からメトリクスデータを取得する。
 * マッピングに存在しないフォントの場合は null を返す。
 */
export function getFontMetrics(fontFamily: string | null | undefined): FontMetrics | null {
  if (!fontFamily) return null;

  const key = fontNameMap[fontFamily] ?? fontNameMap[fontFamily.toLowerCase()];
  if (!key) return null;

  return metricsData[key] ?? null;
}

/**
 * PPTX フォント名に対応するメトリクス互換 OSS フォント名を返す。
 * SVG の font-family フォールバックリストに追加することで、
 * 計測と描画のフォント一致度を上げる。
 */
export function getMetricsFallbackFont(fontFamily: string | null | undefined): string | null {
  if (!fontFamily) return null;

  const key = fontNameMap[fontFamily] ?? fontNameMap[fontFamily.toLowerCase()];
  if (!key) return null;

  return metricsKeyToFontName[key] ?? null;
}
