name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    strategy:
      matrix:
        node-version: [20, 22, 24]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Format check
        run: npm run format:check

      - name: Type check
        run: npm run typecheck

      - name: Test with coverage
        run: npx vitest run --coverage --exclude 'vrt/**'

      - name: Upload coverage report
        if: matrix.node-version == 22
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

      - name: Checkout main branch for coverage comparison
        if: matrix.node-version == 22 && github.event_name == 'pull_request'
        uses: actions/checkout@v4
        with:
          ref: main
          path: __main_branch

      - name: Generate main branch coverage
        if: matrix.node-version == 22 && github.event_name == 'pull_request'
        working-directory: __main_branch
        run: |
          npm ci
          npx vitest run --coverage --exclude 'vrt/**'

      - name: Coverage summary comment
        if: matrix.node-version == 22 && github.event_name == 'pull_request'
        uses: davelosert/vitest-coverage-report-action@v2
        with:
          json-summary-path: coverage/coverage-summary.json
          json-summary-compare-path: __main_branch/coverage/coverage-summary.json

      - name: Build
        run: npm run build

      - name: Verify package (CJS/ESM/TypeScript)
        run: bash scripts/test-package.sh

  vrt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Pull Docker image
        run: docker pull ghcr.io/hirokisakabe/pptx-glimpse-internal-vrt:latest

      - name: Generate VRT fixtures and run VRT
        run: |
          docker run --rm \
            -v "${{ github.workspace }}":/workspace \
            ghcr.io/hirokisakabe/pptx-glimpse-internal-vrt:latest \
            bash /workspace/vrt/internal/docker-run.sh \
            bash -c "npm run vrt:internal:fixtures && npx vitest run vrt/internal/regression.test.ts"

      - name: Upload diff images on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: internal-vrt-diffs
          path: vrt/internal/diffs/
          retention-days: 7

  libreoffice-vrt:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Pull Docker image
        run: docker pull ghcr.io/hirokisakabe/pptx-glimpse-vrt:latest

      - name: Generate fixtures
        run: docker run --rm -v "${{ github.workspace }}":/workspace ghcr.io/hirokisakabe/pptx-glimpse-vrt:latest python3 /workspace/vrt/libreoffice/create_fixtures.py

      - name: Generate LibreOffice reference images
        run: docker run --rm -v "${{ github.workspace }}":/workspace ghcr.io/hirokisakabe/pptx-glimpse-vrt:latest bash /workspace/vrt/libreoffice/update_snapshots.sh

      - name: Run LibreOffice VRT
        run: npx vitest run vrt/libreoffice/regression.test.ts

      - name: Upload diff images on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: libreoffice-vrt-diffs
          path: vrt/libreoffice/diffs/
          retention-days: 7
